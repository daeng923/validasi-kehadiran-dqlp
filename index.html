<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validasi Kehadiran DQLP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .spinner { border-top-color: #059669; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <div class="max-w-md mx-auto py-10 px-4">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-emerald-900 tracking-tight tracking-tighter">DQLP</h1>
            <p class="text-slate-500 text-[10px] mt-1 uppercase tracking-[0.2em] font-bold">Validation System</p>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/60 p-6 md:p-8 border border-slate-100 relative overflow-hidden">
            
            <div id="loginBox" class="space-y-6">
                <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-r-2xl">
                    <p class="text-xs text-emerald-800 leading-relaxed font-medium">
                        Masukkan <b>Email Pengajar</b> dan <b>Token Akses</b> untuk memvalidasi presensi peserta.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Email Pengajar</label>
                        <input id="email" type="email" placeholder="nama@umm.ac.id" 
                            class="w-full px-5 py-3.5 rounded-2xl border border-slate-200 bg-slate-50/50 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-300 text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Token Akses</label>
                        <input id="token" type="password" placeholder="••••••••" 
                            class="w-full px-5 py-3.5 rounded-2xl border border-slate-200 bg-slate-50/50 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-300 text-sm">
                    </div>
                    <button id="btnLogin" onclick="login()" 
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200 transition-all active:scale-[0.98] text-sm tracking-wide">
                        Masuk Sekarang
                    </button>
                </div>

                <div id="loginLoading" class="hidden text-center">
                    <div class="spinner w-6 h-6 border-[3px] border-slate-100 rounded-full mx-auto mb-2"></div>
                    <p class="text-[10px] text-slate-400 font-medium italic">Menghubungkan ke database...</p>
                </div>
            </div>

            <div id="mainBox" class="hidden space-y-6">
                <div class="flex items-center justify-between border-b border-slate-50 pb-4 mb-4">
                    <div class="flex flex-col">
                        <span class="text-[9px] uppercase font-bold text-slate-300 tracking-widest">Pengajar</span>
                        <div class="text-xs font-bold text-slate-600" id="userEmailDisplay"></div>
                    </div>
                    <button onclick="logout()" class="px-3 py-1.5 rounded-lg text-[10px] font-bold text-red-400 hover:bg-red-50 transition-colors uppercase tracking-tighter">Logout</button>
                </div>

                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-wider text-center">Pilih Skema Program</label>
                    <select id="skema" class="w-full px-4 py-3.5 rounded-2xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-emerald-500/20 outline-none text-sm font-semibold text-slate-700 appearance-none"></select>
                    <button id="btnLoad" onclick="loadData()" 
                        class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3.5 rounded-2xl transition-all shadow-md text-xs tracking-wide">
                        Tampilkan Peserta
                    </button>
                </div>

                <div id="filterContainer" class="hidden space-y-4 pt-4 border-t border-slate-50">
                    <div class="relative">
                        <input id="searchBox" onkeyup="filterList()" type="text" placeholder="Cari nama peserta..." 
                            class="w-full pl-10 pr-4 py-3 text-xs rounded-xl border border-slate-100 bg-slate-50 focus:ring-2 focus:ring-emerald-500/20 outline-none transition-all">
                        <svg class="w-4 h-4 text-slate-300 absolute left-3.5 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div id="summaryBox"></div>
                </div>

                <div id="loading" class="hidden text-center py-10">
                    <div class="spinner w-10 h-10 border-[3px] border-slate-100 rounded-full mx-auto mb-3"></div>
                    <p class="text-xs text-slate-400 font-medium">Sedang memproses data...</p>
                </div>

                <div id="emptyBox"></div>
                <div id="list" class="space-y-3 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar"></div>

                <div class="pt-4">
                    <button id="btnSave" onclick="confirmSave()" class="hidden w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-emerald-100 transition-all active:scale-[0.98] text-sm tracking-wide">
                        Konfirmasi Kehadiran
                    </button>
                    <div id="successBox"></div>
                </div>
            </div>
        </div>

        <p class="text-center text-slate-300 text-[9px] mt-8 uppercase tracking-[0.3em] font-bold">
            &copy; 2026 UMM - Quranic Literacy
        </p>
    </div>

    <div id="customAlert" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-[2px] transition-all">
        <div class="bg-white rounded-[2rem] p-8 max-w-xs w-full shadow-2xl text-center transform scale-100">
            <div id="alertIcon" class="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-6 transition-colors">
                </div>
            <h3 id="alertTitle" class="text-lg font-bold text-slate-800 mb-2 leading-tight"></h3>
            <p id="alertMessage" class="text-xs text-slate-500 mb-8 leading-relaxed px-2"></p>
            <button onclick="closeAlert()" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3.5 rounded-xl transition-all shadow-md text-xs uppercase tracking-widest">
                Tutup
            </button>
        </div>
    </div>

    <div id="customConfirm" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-[2px]">
        <div class="bg-white rounded-[2rem] p-8 max-w-xs w-full shadow-2xl text-center">
            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-amber-100 mb-6">
                <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Simpan Validasi?</h3>
            <p id="confirmMessage" class="text-xs text-slate-500 mb-8 leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-3.5 rounded-xl transition-all text-xs">Batal</button>
                <button id="confirmYesBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-100 text-xs">Ya, Simpan</button>
            </div>
        </div>
    </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbznQyEJLnjqMvEkbUOaSjWzmOiMh3rETy9uF-w2rmIJDRLm_oxewxDcncaNXMPB8uQH0g/exec";
let EMAIL = "", DATA = [];

// Helper
const $ = id => document.getElementById(id);

// --- MODAL LOGIC ---
function showAlert(title, message, type = 'success') {
    const icon = $('alertIcon');
    $('alertTitle').innerText = title;
    $('alertMessage').innerText = message;

    if (type === 'error') {
        icon.className = "mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-red-100 text-red-600 mb-6";
        icon.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
    } else {
        icon.className = "mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-emerald-100 text-emerald-600 mb-6";
        icon.innerHTML = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
    }
    $('customAlert').classList.remove('hidden');
}
function closeAlert() { $('customAlert').classList.add('hidden'); }

function confirmSave() {
    const checkedCount = document.querySelectorAll("#list input:checked").length;
    if(checkedCount === 0) return showAlert("Opps!", "Pilih minimal satu peserta yang hadir.", "error");
    
    $('confirmMessage').innerText = `Anda akan memvalidasi ${checkedCount} peserta hadir untuk skema ini.`;
    $('customConfirm').classList.remove('hidden');
    $('confirmYesBtn').onclick = () => {
        closeConfirm();
        simpanData();
    };
}
function closeConfirm() { $('customConfirm').classList.add('hidden'); }

// --- MAIN LOGIC ---
function formatWaktu(raw) {
    if(!raw || raw === "-") return "-";
    const d = new Date(raw);
    if(isNaN(d)) return raw;
    const hari = d.toLocaleDateString("id-ID",{weekday:"long"});
    const tgl = d.toLocaleDateString("id-ID",{day:"2-digit",month:"short"});
    const jam = d.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
    return `<div class="text-[10px] font-bold text-slate-700">${hari}</div><div class="text-[9px] text-slate-400 font-medium">${tgl} • ${jam}</div>`;
}

async function login() {
    const emailVal = $("email").value;
    const tokenVal = $("token").value;
    if(!emailVal || !tokenVal) return showAlert("Data Kosong", "Mohon isi Email dan Token untuk melanjutkan.", "error");

    $("btnLogin").disabled = true;
    $("loginLoading").classList.remove("hidden");

    try {
        const r = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(emailVal)}&token=${encodeURIComponent(tokenVal)}`);
        const j = await r.json();
        if(!j.status) throw new Error(j.msg);
        
        EMAIL = j.email;
        $("userEmailDisplay").innerText = EMAIL;
        $("loginBox").classList.add("hidden");
        $("mainBox").classList.remove("hidden");
        $("skema").innerHTML = j.skema.map(s => `<option>${s}</option>`).join("");
    } catch (err) {
        showAlert("Akses Ditolak", err.message, "error");
    } finally {
        $("btnLogin").disabled = false;
        $("loginLoading").classList.add("hidden");
    }
}

async function loadData() {
    $("btnLoad").disabled = true;
    $("loading").classList.remove("hidden");
    $("list").innerHTML = ""; $("emptyBox").innerHTML = ""; $("successBox").innerHTML = "";
    $("filterContainer").classList.add("hidden"); $("btnSave").classList.add("hidden");

    try {
        const r = await fetch(`${API_URL}?action=list&email=${encodeURIComponent(EMAIL)}&skema=${encodeURIComponent($("skema").value)}`);
        DATA = await r.json();

        if(DATA.length === 0) {
            $("emptyBox").innerHTML = `<div class="p-6 bg-slate-50 text-slate-400 text-[11px] rounded-[2rem] border border-dashed border-slate-200 text-center">Belum ada peserta yang mengisi presensi.</div>`;
        } else {
            $("filterContainer").classList.remove("hidden");
            $("btnSave").classList.remove("hidden");
            renderList(DATA);
            updateSummary();
        }
    } catch (err) {
        showAlert("Gagal Sinkron", "Tidak bisa mengambil data dari server.", "error");
    } finally {
        $("loading").classList.add("hidden");
        $("btnLoad").disabled = false;
    }
}

function renderList(items) {
    $("list").innerHTML = items.map((r, i) => `
        <label class="flex items-center gap-4 p-3.5 bg-white border border-slate-100 rounded-2xl hover:bg-emerald-50/30 transition-all cursor-pointer group" data-nama="${r.nama.toLowerCase()}">
            <input type="checkbox" checked data-i="${i}" onchange="updateSummary()" 
                class="w-5 h-5 rounded-lg text-emerald-600 focus:ring-emerald-500/20 border-slate-200">
            <img src="${r.foto}" onerror="this.src='https://ui-avatars.com/api/?name=${r.nama}&background=random'" class="w-10 h-10 rounded-full object-cover">
            <div class="flex-1 min-w-0">
                <div class="text-[12px] font-bold text-slate-700 truncate group-hover:text-emerald-700 transition-colors">${r.nama}</div>
                <div class="text-[10px] text-slate-400 font-semibold tracking-wide">${r.nip}</div>
            </div>
            <div class="text-right">${formatWaktu(r.waktu)}</div>
        </label>
    `).join("");
}

function filterList() {
    const q = $("searchBox").value.toLowerCase();
    document.querySelectorAll('#list label').forEach(el => {
        el.style.display = el.getAttribute('data-nama').includes(q) ? "flex" : "none";
    });
}

function updateSummary() {
    const checked = document.querySelectorAll("#list input:checked").length;
    $("summaryBox").innerHTML = `
        <div class="flex justify-between items-center px-1">
            <span class="text-[9px] font-bold uppercase tracking-widest text-slate-300">Terpilih</span>
            <span class="text-[10px] font-extrabold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">${checked} Peserta</span>
        </div>`;
}

async function simpanData() {
    const rows = [];
    document.querySelectorAll("#list input:checked").forEach(cb => rows.push(DATA[cb.dataset.i]));
    
    $("btnSave").disabled = true;
    $("loading").classList.remove("hidden");

    try {
        await fetch(API_URL + "?action=simpan&email=" + encodeURIComponent(EMAIL) + "&skema=" + encodeURIComponent($("skema").value) + "&rows=" + encodeURIComponent(JSON.stringify(rows)));
        showAlert("Berhasil!", `${rows.length} Peserta telah divalidasi dan disimpan.`, "success");
        $("list").innerHTML = ""; $("filterContainer").classList.add("hidden"); $("btnSave").classList.add("hidden");
    } catch (err) {
        showAlert("Gagal Simpan", "Terjadi kesalahan saat menyimpan data.", "error");
    } finally {
        $("loading").classList.add("hidden");
        $("btnSave").disabled = false;
    }
}

function logout() { location.reload(); }
// --- KODE PROTEKSI TAMBAHAN ---

// 1. Blokir Klik Kanan (Context Menu)
document.addEventListener('contextmenu', event => event.preventDefault());

// 2. Blokir Shortcut Keyboard untuk Inspeksi (DevTools)
document.onkeydown = function(e) {
    // Blokir F12
    if(e.keyCode == 123) return false;
    
    // Blokir Ctrl+Shift+I (Inspect), Ctrl+Shift+J (Console), Ctrl+U (View Source)
    if(e.ctrlKey && (e.shiftKey || e.keyCode == 'U'.charCodeAt(0))) {
        if(e.keyCode == 'I'.charCodeAt(0) || 
           e.keyCode == 'J'.charCodeAt(0) || 
           e.keyCode == 'C'.charCodeAt(0) || 
           e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
    }
}

// 3. Mencegah Drag Gambar (Foto Peserta agar tidak mudah ditarik/save)
document.addEventListener('dragstart', event => {
    if (event.target.tagName === 'IMG') event.preventDefault();
});

// --- AKHIR KODE PROTEKSI ---
</script>
</body>
</html>
